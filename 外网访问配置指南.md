# DCIM系统外网访问配置指南

## 问题现象
- ✅ 本地登录正常 (http://localhost:3000)
- ❌ 外网无法登录 (http://powerlab.cn:3000)

## 原因分析
经测试确认：
1. ✅ 后端服务正常运行在 0.0.0.0:8080
2. ✅ 前端服务正常运行在 0.0.0.0:3000
3. ✅ Windows防火墙规则已添加
4. ❌ **路由器端口转发未配置** ← 问题所在

## 解决方案：配置路由器端口转发

### 步骤 1: 确定本机内网IP

打开命令提示符，运行：
```cmd
ipconfig
```

查找 "IPv4 地址" 或 "IPv4 Address"，例如：
```
IPv4 地址: 192.168.1.100
```

记录这个IP地址，后面需要用到。

### 步骤 2: 登录路由器管理界面

1. 打开浏览器
2. 在地址栏输入路由器管理地址（常见的有）：
   - `http://192.168.1.1`
   - `http://192.168.0.1`
   - `http://192.168.2.1`
   - `http://10.0.0.1`

3. 输入管理员账号密码（通常在路由器背面标签上）

### 步骤 3: 配置端口转发

不同品牌路由器界面不同，但基本步骤相似：

#### 查找端口转发设置
路由器管理界面中找到以下菜单之一：
- **转发规则** / **虚拟服务器** / **端口映射**
- **Port Forwarding** / **Virtual Server**
- **高级设置** → **端口转发**
- **应用管理** → **虚拟服务器**

#### 添加端口转发规则

**规则 1: 后端服务（8080端口）**
```
服务名称：DCIM Backend
外部端口：8080
内部端口：8080
内部IP地址：192.168.1.100  (你的服务器IP)
协议：TCP
启用：是
```

**规则 2: 前端服务（3000端口）**
```
服务名称：DCIM Frontend
外部端口：3000
内部端口：3000
内部IP地址：192.168.1.100  (你的服务器IP)
协议：TCP
启用：是
```

### 常见路由器配置示例

#### TP-Link路由器
1. 登录路由器 (192.168.1.1)
2. **转发规则** → **虚拟服务器**
3. 点击 **添加新条目**
4. 填写端口转发信息
5. 保存并重启路由器

#### 华为路由器
1. 登录路由器 (192.168.3.1)
2. **更多功能** → **安全设置** → **虚拟服务器**
3. 点击 **添加**
4. 填写端口转发信息
5. 保存

#### 小米路由器
1. 登录路由器 (192.168.31.1 或 miwifi.com)
2. **高级设置** → **端口转发**
3. 点击 **添加规则**
4. 填写端口转发信息
5. 保存

### 步骤 4: 验证配置

#### 4.1 从外网测试后端
使用手机移动数据（不连WiFi）或让其他人帮忙测试：

**测试后端API文档**
```
http://powerlab.cn:8080/docs
```
应该能看到API文档页面。

**测试登录接口**（使用curl或Postman）
```bash
curl http://powerlab.cn:8080/api/v1/auth/login -X POST -d "username=admin&password=admin123"
```
应该返回包含 `access_token` 的JSON。

#### 4.2 测试前端登录
手机移动数据访问：
```
http://powerlab.cn:3000
```
输入账号 `admin` 密码 `admin123` 应该能登录。

### 常见问题排查

#### Q1: 路由器配置完还是不行？

**A:** 检查以下几点：

1. **服务器IP是否固定？**
   - 建议在路由器DHCP设置中，为服务器MAC地址绑定固定IP
   - 否则重启后IP可能变化，端口转发会失效

2. **路由器是否重启？**
   - 某些路由器需要重启才能生效

3. **公网IP是否正确？**
   - 运行 `ipconfig` 查看的是内网IP (192.168.x.x)
   - 需要运行以下命令获取公网IP：
     ```cmd
     curl http://myip.ipip.net
     ```
   - 或访问 `http://ip.cn` 查看公网IP
   - 确认 `powerlab.cn` 解析到正确的公网IP

4. **ISP是否封锁端口？**
   - 部分运营商会封锁常见端口（80、8080等）
   - 如果8080被封，可以改用其他端口（如8888）
   - 修改步骤：
     - 后端: `start.bat` 中改为 `--port 8888`
     - 路由器: 外部端口改为8888
     - 前端: `request.ts` 中 `backendPort = 8888`
     - 重新构建前端: `npm run build`

#### Q2: 如何测试端口是否开放？

**A:** 使用在线工具测试：

1. 访问 https://tool.chinaz.com/port/
2. 输入域名: `powerlab.cn`
3. 输入端口: `8080` 和 `3000`
4. 点击检测

如果显示"开放"则配置成功，如果"关闭"则端口转发未生效。

#### Q3: 能否用域名+标准端口访问？

**A:** 可以，但需要使用反向代理（如Nginx）：

**配置Nginx** (更专业的方案)：
```nginx
server {
    listen 80;
    server_name powerlab.cn;

    # 前端
    location / {
        proxy_pass http://localhost:3000;
    }

    # 后端API
    location /api {
        proxy_pass http://localhost:8080/api;
    }

    # WebSocket
    location /ws {
        proxy_pass http://localhost:8080/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

这样就可以直接用 `http://powerlab.cn` 访问，无需端口号。

### 检查清单

在配置路由器前，请确认：

- [ ] 服务器IP地址已记录
- [ ] 后端服务运行在 0.0.0.0:8080
- [ ] 前端服务运行在 0.0.0.0:3000
- [ ] Windows防火墙规则已添加
- [ ] 路由器管理员密码已准备
- [ ] 已确认路由器型号和管理地址

配置路由器后，请确认：

- [ ] 端口转发规则已添加（8080和3000）
- [ ] 路由器已重启（如需要）
- [ ] 从外网可以访问 http://powerlab.cn:8080/docs
- [ ] 从外网可以访问 http://powerlab.cn:3000
- [ ] 可以用admin/admin123登录

### 获取帮助

如果按照本指南配置后仍然无法访问，请提供：

1. 路由器品牌和型号
2. 端口转发配置截图
3. 外网访问时的错误信息（浏览器F12控制台）
4. 在线端口检测结果

## 快速命令参考

```batch
# 查看本机IP
ipconfig

# 查看公网IP
curl http://myip.ipip.net

# 测试后端本地
curl http://localhost:8080/docs

# 测试后端外网（需在其他网络环境）
curl http://powerlab.cn:8080/docs

# 添加防火墙规则
netsh advfirewall firewall add rule name="DCIM Backend 8080" dir=in action=allow protocol=TCP localport=8080
netsh advfirewall firewall add rule name="DCIM Frontend 3000" dir=in action=allow protocol=TCP localport=3000

# 查看正在监听的端口
netstat -ano | findstr "8080"
netstat -ano | findstr "3000"
```

---

**注意**：本指南假设您有路由器管理权限。如果是公司网络或学校网络，可能需要联系网络管理员配置。
