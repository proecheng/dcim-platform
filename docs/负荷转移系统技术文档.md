# 负荷转移系统技术文档

> 版本: V2.5 | 更新日期: 2026-02-01

---

## 目录

1. [系统概述](#1-系统概述)
2. [核心概念与术语](#2-核心概念与术语)
3. [系统架构](#3-系统架构)
4. [数据模型](#4-数据模型)
5. [配置与设置](#5-配置与设置)
6. [核心算法](#6-核心算法)
7. [完整操作流程](#7-完整操作流程)
8. [API 接口参考](#8-api-接口参考)
9. [电价与时段体系](#9-电价与时段体系)
10. [收益计算模型](#10-收益计算模型)
11. [约束与安全机制](#11-约束与安全机制)
12. [执行与追踪](#12-执行与追踪)

---

## 1. 系统概述

### 1.1 什么是负荷转移

负荷转移（Load Shifting）是一种用电优化策略，通过将部分用电负荷从**高电价时段**（尖峰/峰时）转移到**低电价时段**（谷时/深谷），在不改变总用电量的前提下降低用电成本。

### 1.2 系统目标

- **智能分析**：基于历史用电数据，自动识别可转移设备和最优转移比例
- **方案规划**：提供交互式转移方案配置，支持多设备、多规则组合
- **收益预估**：实时计算日/年节省金额，提供转移前后负荷对比曲线
- **执行管理**：从方案到执行的全生命周期管理，包含效果追踪

### 1.3 适用场景

| 场景 | 说明 |
|------|------|
| 峰谷电价套利 | 利用分时电价差异，将高价时段负荷转移至低价时段 |
| 需量管理 | 通过削峰填谷降低最大需量，减少基本电费 |
| 电网响应 | 配合电网调度，在高峰时段主动削减负荷 |

---

## 2. 核心概念与术语

| 术语 | 英文 | 含义 |
|------|------|------|
| 可转移功率比例 | Shiftable Power Ratio | 设备额定功率中可被转移的比例（0~1） |
| 柔性系数 | Flexibility Factor | 设备类型固有的负荷调节灵活程度 |
| 源时段 | Source Period | 负荷转出的高价时段（尖峰/峰时/平时） |
| 目标时段 | Target Period | 负荷转入的低价时段（平时/谷时/深谷） |
| 转移规则 | Shift Rule | 一条完整的转移指令：源时段 → 目标时段 + 功率 + 时长 |
| 置信度 | Confidence | 推荐值的可靠程度，取决于历史数据天数 |
| 关键负荷 | Critical Load | 不可中断或转移的重要设备（如 UPS、IT 服务器） |
| 典型日Profile | Typical Day Profile | 基于历史数据聚合的24小时功率曲线 |

---

## 3. 系统架构

### 3.1 模块组成

```
┌─────────────────────────────────────────────────────────┐
│                      前端界面层                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │ 转移配置  │  │ 负荷分析  │  │ 方案规划  │  │执行管理  │ │
│  │ config   │  │ analysis │  │ShiftPlan │  │execution│ │
│  │ .vue     │  │ .vue     │  │Builder   │  │ .vue    │ │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬────┘ │
│       │              │             │              │      │
│  ┌────┴──────────────┴─────────────┴──────────────┴────┐ │
│  │              API 调用层 (energy.ts)                   │ │
│  └─────────────────────┬───────────────────────────────┘ │
└────────────────────────┼────────────────────────────────┘
                         │ HTTP REST
┌────────────────────────┼────────────────────────────────┐
│                      后端服务层                           │
│  ┌─────────────────────┴───────────────────────────────┐ │
│  │              API 路由 (energy.py / execution.py)      │ │
│  └────┬───────────────┬────────────────────┬───────────┘ │
│       │               │                    │             │
│  ┌────┴─────┐  ┌──────┴──────┐  ┌─────────┴──────────┐ │
│  │设备调控   │  │能耗分析      │  │执行计划             │ │
│  │服务      │  │服务          │  │服务                 │ │
│  │(核心算法) │  │(负荷转移     │  │(计划/任务/追踪)     │ │
│  │          │  │ 分析插件)    │  │                     │ │
│  └────┬─────┘  └──────┬──────┘  └─────────┬──────────┘ │
│       │               │                    │             │
│  ┌────┴───────────────┴────────────────────┴───────────┐ │
│  │              数据库层 (SQLite/PostgreSQL)              │ │
│  │  device_shift_configs | energy_hourly | energy_daily │ │
│  │  load_regulation_configs | execution_plans | tasks   │ │
│  └─────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────┘
```

### 3.2 前端核心组件

| 组件 | 文件路径 | 职责 |
|------|---------|------|
| 转移配置 Tab | `views/energy/config.vue` (第295-395行) | 设备转移比例配置与推荐 |
| 负荷转移分析 Tab | `views/energy/analysis.vue` | 负荷转移潜力分析与汇总 |
| 方案规划器 | `components/energy/ShiftPlanBuilder.vue` | 交互式多设备多规则方案配置 |
| 设备详情抽屉 | `components/energy/DeviceShiftDetailDrawer.vue` | 单设备24h功率曲线与约束分析 |
| 负荷对比图 | `components/energy/LoadComparisonChart.vue` | 转移前后负荷曲线对比 |
| 执行确认对话框 | `components/energy/ExecutionPlanDialog.vue` | 执行计划创建确认 |
| 执行管理页 | `views/energy/execution.vue` | 计划生命周期管理与效果追踪 |

### 3.3 后端核心服务

| 服务 | 文件路径 | 职责 |
|------|---------|------|
| DeviceRegulationService | `services/device_regulation_service.py` | 设备转移能力查询、比例推荐算法、约束验证 |
| LoadShiftAnalysisService | `services/energy_analysis.py` | 峰谷分布分析、设备转移潜力评估 |
| LoadShiftingPlugin | `services/analysis_plugins/load_shifting.py` | 负荷转移分析插件（按计量点分组） |
| ExecutionService | API层内联 | 执行计划 CRUD、任务管理、效果追踪 |

---

## 4. 数据模型

### 4.1 设备负荷转移配置表 (`device_shift_configs`)

存储每个设备的转移能力参数和约束条件。

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `id` | Integer PK | 自增 | 主键 |
| `device_id` | Integer FK | - | 关联 `power_devices.id` |
| `is_shiftable` | Boolean | False | 是否可转移 |
| `shiftable_power_ratio` | Float | 0 | 可转移功率比例 (0~1) |
| `is_critical` | Boolean | False | 是否关键负荷（不可转移） |
| `allowed_shift_hours` | JSON | [] | 允许转移的时段，如 `[22,23,0,1,2,3,4,5]` |
| `forbidden_shift_hours` | JSON | [] | 禁止转移的时段 |
| `min_continuous_runtime` | Float | - | 最小连续运行时间（小时） |
| `max_shift_duration` | Float | - | 单次最大转移持续时间（小时） |
| `min_power` | Float | - | 最低运行功率 (kW) |
| `max_ramp_rate` | Float | - | 最大爬坡速率 (kW/min) |
| `shift_notice_time` | Integer | 30 | 转移提前通知时间（分钟） |
| `requires_manual_approval` | Boolean | True | 是否需要人工确认 |

### 4.2 负荷调节配置表 (`load_regulation_configs`)

存储设备的参数调节能力（温度、亮度、频率等），用于精细化功率控制。

| 字段 | 类型 | 说明 |
|------|------|------|
| `device_id` | Integer FK | 关联用电设备 |
| `regulation_type` | String | 调节类型: `temperature` / `brightness` / `mode` / `load` |
| `min_value` / `max_value` | Float | 可调范围 |
| `current_value` / `default_value` | Float | 当前值/默认值 |
| `step_size` | Float | 调节步长（默认1.0） |
| `unit` | String | 单位: `℃` / `%` / `mode` |
| `power_factor` | Float | 功率系数（每单位变化对应的功率变化 kW） |
| `base_power` | Float | 基准功率 kW |
| `power_curve` | JSON | 功率曲线 `[{value, power}, ...]` |
| `priority` | Integer | 调节优先级 1-10（1最高） |
| `comfort_impact` | String | 舒适度影响: `none`/`low`/`medium`/`high` |
| `performance_impact` | String | 性能影响: `none`/`low`/`medium`/`high` |
| `is_auto` | Boolean | 是否自动调节 |

### 4.3 执行计划与任务表

**执行计划表 (`execution_plans`)**：

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | Integer PK | 计划ID |
| `plan_name` | String | 方案名称 |
| `strategy` | String | 策略: `max_benefit` / `min_cost` |
| `daily_saving` | Float | 预期日节省（元） |
| `annual_saving` | Float | 预期年节省（元） |
| `device_rules` | JSON | 设备转移规则配置快照 |
| `status` | String | 状态: `pending`/`in_progress`/`completed`/`cancelled` |
| `remark` | Text | 备注 |

**执行任务表 (`execution_tasks`)**：

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | Integer PK | 任务ID |
| `plan_id` | Integer FK | 关联执行计划 |
| `device_id` | Integer | 设备ID |
| `task_type` | String | 任务类型: `auto` / `manual` |
| `source_period` | String | 源时段 |
| `target_period` | String | 目标时段 |
| `power` | Float | 转移功率 kW |
| `hours` | Float | 转移时长 h |
| `status` | String | 状态: `pending`/`in_progress`/`completed` |

---

## 5. 配置与设置

### 5.1 设备类型调节方式映射

系统为不同设备类型预定义了调节方式：

| 设备类型 | 调节方式 |
|---------|---------|
| HVAC（暖通空调） | 调节供电频率/设定温度改变功率 |
| AC（空调） | 调节供电频率/设定温度改变功率 |
| PUMP（水泵） | 变频调速控制流量 |
| COMPRESSOR（压缩机） | 变频调速/台数控制 |
| LIGHTING（照明） | 分区控制/调光 |
| CHILLER（冷水机组） | 调节冷冻水温度/变频控制 |
| COOLING_TOWER（冷却塔） | 变频调速/风机台数控制 |
| AHU（空气处理机组） | 变频调速/新风比例调节 |
| UPS（不间断电源） | ECO模式切换（**不可转移**） |
| IT_SERVER（IT服务器） | 负载迁移/休眠策略（**不可转移**） |
| IT_STORAGE（IT存储） | 分层存储策略（**不可转移**） |

### 5.2 设备类型柔性系数 (Flexibility Factor)

柔性系数表示该类设备在负荷调节方面的灵活程度，值越高表示越容易转移。

| 设备类型 | 柔性系数 | 说明 |
|---------|---------|------|
| LIGHTING | 0.8 | 照明最灵活，可分区关停 |
| PUMP | 0.7 | 水泵可变频调速 |
| HVAC | 0.6 | 暖通有一定热惯性缓冲 |
| AC | 0.5 | 空调受舒适度约束 |
| COOLING_TOWER | 0.5 | 冷却塔可调速 |
| AHU | 0.5 | 空气处理机组可调速 |
| CHILLER | 0.4 | 冷水机组启停约束较强 |
| COMPRESSOR | 0.4 | 压缩机启停约束较强 |
| 其他/未知 | 0.3 | 默认保守值 |

### 5.3 设备类型最大可转移比例 (Type Max Ratio)

每种设备类型的可转移功率上限（硬约束）：

| 设备类型 | 最大比例 | 含义 |
|---------|---------|------|
| LIGHTING | 60% | 最多可转移额定功率的60% |
| PUMP | 50% | 50% |
| HVAC | 45% | 45% |
| AC | 40% | 40% |
| COOLING_TOWER | 40% | 40% |
| AHU | 35% | 35% |
| CHILLER | 30% | 30% |
| COMPRESSOR | 30% | 30% |
| UPS | **0%** | 不可转移 |
| IT_SERVER | **0%** | 不可转移 |
| IT_STORAGE | **0%** | 不可转移 |
| 其他/未知 | 30% | 默认保守值 |

### 5.4 默认时段配置

系统将一天24小时划分为5个电价时段：

| 小时 | 时段类型 | 电价等级 |
|------|---------|---------|
| 0:00 ~ 5:59 | **深谷** (deep_valley) | 最低 |
| 6:00 ~ 7:59 | **谷时** (valley) | 低 |
| 8:00, 12:00 ~ 16:00, 21:00 | **平时** (flat) | 中 |
| 9:00 ~ 10:00, 17:00, 19:00 ~ 20:00 | **峰时** (peak) | 高 |
| 11:00, 18:00 | **尖峰** (sharp) | 最高 |
| 22:00 ~ 23:59 | **谷时** (valley) | 低 |

---

## 6. 核心算法

### 6.1 可转移比例智能推荐算法

这是系统的核心算法，位于 `DeviceRegulationService._calculate_recommendation()` 方法中。

#### 输入数据

| 数据 | 来源 | 说明 |
|------|------|------|
| `rated_power` | 设备基础信息 | 设备额定功率 (kW) |
| `avg_power` | `energy_hourly` 表聚合 | 历史平均功率 |
| `max_power` | `energy_hourly` 表聚合 | 历史最大功率 |
| `min_power` | `energy_hourly` 表聚合 | 历史最低功率 |
| `peak_ratio` | `energy_daily` 表聚合 | 峰时用电占比 |
| `flexibility` | 设备类型查表 | 柔性系数 |
| `type_max` | 设备类型查表 | 类型最大可转移比例 |

> 若无历史数据，使用默认估算值：`avg = 0.7 × rated`, `max = 0.9 × rated`, `min = 0.3 × rated`

#### 四约束模型

算法基于**四个独立约束条件**取最小值，确保推荐值同时满足所有安全限制：

```
约束1: 最低功率约束
  constraint_1 = max(0, 1 - min_power / rated_power)
  含义: 设备历史最低功率不可削减，剩余部分才是可转移空间

约束2: 负荷波动空间
  constraint_2 = max(0, (max_power - avg_power) / rated_power)
  含义: 历史最大功率与平均功率之差，代表实际可削减的功率空间

约束3: 峰时转移潜力
  constraint_3 = peak_ratio × flexibility_factor
  含义: 峰时用电占比越高 × 设备越灵活 = 转移潜力越大

约束4: 设备类型硬上限
  constraint_4 = type_max_ratio
  含义: 该设备类型允许的最大转移比例（安全红线）
```

#### 综合计算

```
raw_ratio = min(constraint_1, constraint_2, constraint_3, constraint_4)

recommended_ratio = raw_ratio × 0.85    // 安全系数，留15%余量

// 范围校正
recommended_ratio = clamp(recommended_ratio, 0, type_max_ratio)

// 四舍五入到2位小数
recommended_ratio = round(recommended_ratio, 2)
```

#### 置信度评估

| 历史数据天数 | 置信度 | 含义 |
|------------|--------|------|
| >= 30 天 | **high** (高) | 数据充分，推荐值可靠 |
| >= 14 天 | **medium** (中) | 数据基本够用，建议观察 |
| < 14 天 | **low** (低) | 数据不足，仅供参考 |

#### 变更判定

当推荐值与当前值的差异超过 **1%** 时，标记为有变更（`has_change = true`）。

#### 计算示例

假设一台 PUMP（水泵）设备：
- 额定功率: 100 kW
- 历史最低功率: 40 kW → constraint_1 = 1 - 40/100 = **0.60**
- 历史最大功率: 85 kW, 平均功率: 65 kW → constraint_2 = (85-65)/100 = **0.20**
- 峰时占比: 0.45, 柔性系数: 0.7 → constraint_3 = 0.45 × 0.7 = **0.315**
- PUMP 类型上限 → constraint_4 = **0.50**

```
raw_ratio = min(0.60, 0.20, 0.315, 0.50) = 0.20
recommended = 0.20 × 0.85 = 0.17
可转移功率 = 100 × 0.17 = 17 kW
```

### 6.2 设备转移潜力评估算法

位于 `LoadShiftAnalysisService._analyze_device_potential()` 方法中。

```
daily_shift_hours = 4                   // 假设每天可转移4小时
shift_efficiency = 0.8                  // 80%转移效率

monthly_shift_energy = shiftable_power × daily_shift_hours × 30 × shift_efficiency
monthly_saving = monthly_shift_energy × (peak_price - valley_price)
```

#### 分析参数默认值

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `peak_ratio_threshold` | 0.35 | 峰时用电占比超过此值才被视为有转移价值 |
| `min_shift_amount` | 50 kWh | 最小月转移电量阈值 |
| `shift_efficiency` | 0.7 | 转移效率（考虑实际损耗） |
| `device_min_power` | 5 kW | 设备最小功率阈值（低于此值忽略） |
| `min_device_shift_saving` | 100 元 | 单设备最小年节省金额阈值 |

### 6.3 转移方案收益计算

位于前端 `ShiftPlanBuilder.vue` 组件中的实时计算逻辑。

#### 单条规则日节省

```
单条规则日节省 = 转移功率(kW) × 转移时长(h) × (源时段电价 - 目标时段电价)
```

#### 汇总计算

```
总日节省 = Σ 所有设备所有规则的日节省
总年节省 = 总日节省 × 250    // 按250个工作日计
```

### 6.4 典型日功率Profile生成算法

位于 `DeviceRegulationService.get_device_typical_profile()` 方法中。

**数据源**: `energy_hourly` 表

**聚合方式**:
```sql
SELECT
  EXTRACT(hour FROM stat_time) AS hour,
  AVG(avg_power) AS avg_power,
  MAX(max_power) AS max_power,
  MIN(min_power) AS min_power,
  COUNT(*) AS record_count
FROM energy_hourly
WHERE device_id = ? AND stat_time >= (NOW - N days)
GROUP BY EXTRACT(hour FROM stat_time)
ORDER BY hour
```

**无数据时的模拟**: 基于额定功率生成钟形曲线
```python
base = rated_power × 0.6
avg_power = base × (0.8 + 0.4 × (0.5 - |hour - 14| / 24))
# 模拟白天高、夜间低的用电模式
```

**汇总指标计算**:
- 负载率 = 24h平均功率 / 额定功率
- 峰时用电占比 = 尖峰+峰时小时的平均功率之和 / 24h总功率之和

---

## 7. 完整操作流程

### 7.1 全局流程图

```
 ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
 │  阶段一   │────>│  阶段二   │────>│  阶段三   │────>│  阶段四   │
 │ 设备配置  │     │ 分析评估  │     │ 方案规划  │     │ 执行追踪  │
 │          │     │          │     │          │     │          │
 │ 转移配置  │     │ 负荷分析  │     │ShiftPlan │     │ 执行管理  │
 │ Tab      │     │ Tab      │     │ Builder  │     │ 页面     │
 └──────────┘     └──────────┘     └──────────┘     └──────────┘
```

---

### 7.2 阶段一：设备转移比例配置

**入口**: 能源配置页 → "转移配置" 选项卡

**步骤**:

```
1. 系统自动加载
   │
   ├─ 调用 GET /api/v1/energy/devices/shift-ratio/recommendations?days=30
   │   → DeviceRegulationService.get_ratio_recommendations(30)
   │   → 对每个设备执行四约束推荐算法
   │
   └─ 返回设备列表，每行显示：
      设备编码 | 名称 | 类型 | 额定功率 | 当前比例 | 推荐比例 | 可转移功率 | 置信度

2. 查看设备详情（可选）
   │
   ├─ 点击表格某一行
   │   → 调用 GET /api/v1/energy/devices/{id}/typical-day-profile?days=30
   │   → 打开 DeviceShiftDetailDrawer 抽屉
   │
   └─ 抽屉内容：
      ├─ 24小时典型日功率曲线（ECharts折线图）
      ├─ 关键指标：负载率、峰时占比、当前/推荐可转移功率
      └─ 四个约束条件的具体数值

3. 调整比例
   │
   ├─ 方式A：单个接受 → 点击行内"接受"按钮
   │   → PUT /api/v1/energy/devices/{id}/shift-ratio {ratio: 推荐值}
   │
   ├─ 方式B：自定义调整 → 点击"调整"按钮 → 弹出滑块对话框
   │   → 拖动滑块或输入数值 → PUT /api/v1/energy/devices/{id}/shift-ratio
   │
   ├─ 方式C：全部接受 → 点击顶部"全部接受推荐值"
   │   → POST /api/v1/energy/devices/shift-ratio/accept-all {days: 30}
   │
   └─ 方式D：批量更新
       → POST /api/v1/energy/devices/shift-ratio/batch-update {updates: {id:ratio,...}}
```

---

### 7.3 阶段二：负荷转移分析

**入口**: 能源分析页 → "负荷转移" 选项卡

**步骤**:

```
1. 加载分析数据
   │
   ├─ 调用 GET /api/v1/energy/analysis/device-shift
   │   → 返回设备转移潜力评估结果
   │
   └─ 页面显示：
      ├─ 汇总卡片：设备总数 | 可转移设备 | 可转移功率(kW) | 潜在月节省(元)
      ├─ 优化建议 Alert
      └─ 负荷分布图（各时段占比可视化）

2. 查看峰谷分布
   │
   └─ 调用 GET /api/v1/energy/analysis/load-period-distribution
       → 返回各时段用电量占比和费用分布
```

---

### 7.4 阶段三：方案规划（ShiftPlanBuilder 核心）

**位置**: 负荷转移分析页中嵌入的 ShiftPlanBuilder 组件

**详细步骤**:

```
步骤1: 选择参与转移的设备
   │
   ├─ 左侧设备列表显示所有 is_shiftable=true 的设备
   ├─ 通过复选框多选（显示：设备名、类型、额定功率、可转移功率）
   └─ 选中后底部显示汇总：已选N台，总可转移功率 XXX kW

步骤2: 选择优化策略
   │
   ├─ 效益最大化 (max_benefit)：优先选择电价差最大的时段组合
   │   → 尖峰 → 深谷（价差最大）
   │   → 峰时 → 谷时
   │
   └─ 成本最小化 (min_cost)：优先选择对生产影响最小的转移
       → 峰时 → 平时（价差较小但影响最低）
       → 平时 → 谷时

步骤3: 获取智能推荐（可选）
   │
   ├─ 点击"推荐方案"按钮
   └─ 系统根据策略自动生成每个设备的转移规则：
      │
      ├─ max_benefit 策略：
      │   规则1: sharp → deep_valley, 功率=可转移功率×60%, 时长=2h
      │   规则2: peak → valley, 功率=可转移功率×40%, 时长=3h
      │
      └─ min_cost 策略：
          规则1: peak → flat, 功率=可转移功率×50%, 时长=2h
          规则2: flat → valley, 功率=可转移功率×30%, 时长=2h

步骤4: 手动调整规则
   │
   ├─ 展开右侧任意设备卡片
   ├─ 每条规则可配置：
   │   ├─ 源时段（下拉选择：尖峰/峰时/平时）
   │   ├─ 目标时段（下拉选择：平时/谷时/深谷）
   │   ├─ 转移功率 (kW)，不超过设备可转移功率
   │   └─ 转移时长 (h)
   │
   ├─ 可增删规则（每个设备支持多条规则）
   └─ 每条规则右侧实时显示日节省金额

步骤5: 查看收益预估
   │
   ├─ 右侧汇总区实时更新：
   │   ├─ 配置设备数
   │   ├─ 总规则数
   │   ├─ 总转移功率 (kW)
   │   ├─ 预计日节省 (元)
   │   └─ 预计年节省 (元) = 日节省 × 250
   │
   └─ 底部 LoadComparisonChart 实时绘制转移前后对比曲线

步骤6: 确认执行
   │
   ├─ 点击"执行方案"按钮
   ├─ 弹出 ExecutionPlanDialog 确认对话框
   │   ├─ 方案名称（自动生成，可编辑）
   │   ├─ 策略、预期收益、涉及设备列表
   │   └─ 备注（可选）
   │
   ├─ 确认后调用 POST /api/v1/execution/plans/from-shift
   │   请求体: {
   │     plan_name, strategy, daily_saving, annual_saving,
   │     device_rules: [{device_id, device_name, rules: [{source_period, target_period, power, hours}]}],
   │     remark
   │   }
   │
   └─ 创建成功后自动跳转到"执行管理"页面
```

---

### 7.5 阶段四：执行与追踪

**入口**: 能源管理 → 执行管理页

**步骤**:

```
1. 查看执行计划列表
   │
   ├─ 调用 GET /api/v1/execution/plans
   └─ 显示所有计划：ID | 名称 | 预期节省 | 状态 | 创建时间

2. 启动计划
   │
   ├─ 点击"开始执行"
   └─ PUT /api/v1/execution/plans/{id}/status {status: "in_progress"}

3. 执行任务
   │
   ├─ 进入计划详情 → 查看任务清单
   │
   ├─ 自动任务：点击"执行" → POST /api/v1/execution/tasks/{id}/execute
   │   → 系统自动发送调控指令
   │
   └─ 手动任务：人工操作后点击"标记完成"
       → POST /api/v1/execution/tasks/{id}/complete

4. 效果追踪
   │
   ├─ 计划完成后点击"效果追踪"
   ├─ GET /api/v1/execution/plans/{id}/tracking
   └─ 显示：预期节省 vs 实际节省、达成率

5. 统计汇总
   │
   └─ GET /api/v1/execution/stats/summary
       → 总计划数、预期年节省、实际年节省、总体达成率
```

---

## 8. API 接口参考

### 8.1 设备转移配置接口

#### 获取可转移设备列表

```
GET /api/v1/energy/devices/shiftable
```

**响应示例**:
```json
[
  {
    "device_id": 1,
    "device_code": "AC-001",
    "device_name": "1号空调机组",
    "device_type": "AC",
    "rated_power": 150.0,
    "shiftable_power": 45.0,
    "shiftable_ratio": 0.3,
    "allowed_shift_hours": [22, 23, 0, 1, 2, 3, 4, 5],
    "forbidden_shift_hours": [9, 10, 11],
    "min_continuous_runtime": 2.0,
    "max_shift_duration": 4.0,
    "min_power": 30.0,
    "max_ramp_rate": 5.0,
    "shift_notice_time": 30,
    "requires_manual_approval": true,
    "is_critical": false,
    "regulation_method": "调节供电频率/设定温度改变功率"
  }
]
```

#### 获取转移比例推荐值

```
GET /api/v1/energy/devices/shift-ratio/recommendations?days=30
```

**响应示例**:
```json
{
  "total_devices": 15,
  "devices_with_change": 8,
  "recommendations": [
    {
      "device_id": 1,
      "device_code": "AC-001",
      "device_name": "1号空调机组",
      "device_type": "AC",
      "rated_power": 150.0,
      "current_ratio": 0.2,
      "recommended_ratio": 0.28,
      "current_shiftable_power": 30.0,
      "recommended_shiftable_power": 42.0,
      "confidence": "high",
      "data_days": 30,
      "has_change": true,
      "calculation_details": {
        "avg_power": 95.0,
        "max_power": 130.0,
        "min_power": 45.0,
        "peak_ratio": 0.42,
        "flexibility_factor": 0.5,
        "type_max_ratio": 0.4,
        "constraints": [0.7, 0.233, 0.21, 0.4],
        "raw_ratio": 0.21
      }
    }
  ],
  "summary": {
    "current_total_power": 320.0,
    "recommended_total_power": 485.0,
    "power_change": 165.0,
    "analysis_days": 30
  }
}
```

#### 更新单个设备转移比例

```
PUT /api/v1/energy/devices/{device_id}/shift-ratio
Content-Type: application/json

{ "ratio": 0.28 }
```

#### 全部接受推荐值

```
POST /api/v1/energy/devices/shift-ratio/accept-all
Content-Type: application/json

{ "days": 30 }
```

#### 获取设备典型日Profile

```
GET /api/v1/energy/devices/{device_id}/typical-day-profile?days=30
```

**响应示例**:
```json
{
  "device_id": 1,
  "device_name": "1号空调机组",
  "device_type": "AC",
  "rated_power": 150.0,
  "data_days": 28,
  "hourly_profile": [
    {"hour": 0, "avg_power": 35.2, "max_power": 42.0, "min_power": 28.5, "period_type": "deep_valley"},
    {"hour": 1, "avg_power": 33.8, "max_power": 40.1, "min_power": 27.2, "period_type": "deep_valley"},
    "... (24小时完整数据)"
  ],
  "summary": {
    "avg_power": 95.0,
    "max_power": 138.5,
    "min_power": 27.2,
    "load_rate": 0.633,
    "peak_energy_ratio": 0.42,
    "has_real_data": true
  }
}
```

### 8.2 负荷转移分析接口

#### 设备负荷转移分析

```
GET /api/v1/energy/analysis/device-shift
```

#### 负荷时段分布

```
GET /api/v1/energy/analysis/load-period-distribution
```

### 8.3 执行计划接口

#### 从转移方案创建执行计划

```
POST /api/v1/execution/plans/from-shift
Content-Type: application/json

{
  "plan_name": "2026年2月峰谷优化方案",
  "strategy": "max_benefit",
  "daily_saving": 1250.5,
  "annual_saving": 312625.0,
  "device_rules": [
    {
      "device_id": 1,
      "device_name": "1号空调机组",
      "rules": [
        {"source_period": "sharp", "target_period": "deep_valley", "power": 27.0, "hours": 2},
        {"source_period": "peak", "target_period": "valley", "power": 18.0, "hours": 3}
      ]
    }
  ],
  "remark": "首次执行，观察效果"
}
```

#### 获取执行计划列表

```
GET /api/v1/execution/plans?status=in_progress&skip=0&limit=20
```

#### 更新计划状态

```
PUT /api/v1/execution/plans/{plan_id}/status
Content-Type: application/json

{ "status": "in_progress" }
```

#### 执行自动任务

```
POST /api/v1/execution/tasks/{task_id}/execute?force=false
```

#### 完成手动任务

```
POST /api/v1/execution/tasks/{task_id}/complete
Content-Type: application/json

{ "actual_power": 25.5, "notes": "实际转移25.5kW" }
```

#### 获取效果追踪数据

```
GET /api/v1/execution/plans/{plan_id}/tracking
```

#### 获取执行统计汇总

```
GET /api/v1/execution/stats/summary
```

---

## 9. 电价与时段体系

### 9.1 五段式分时电价

| 时段类型 | 中文 | 前端默认电价 (元/kWh) | 后端默认电价 (元/kWh) |
|---------|------|---------------------|---------------------|
| `sharp` | 尖峰 | 1.40 | 1.50 |
| `peak` | 峰时 | 1.00 | 1.20 |
| `flat` | 平时 | 0.65 | 0.80 |
| `valley` | 谷时 | 0.35 | 0.40 |
| `deep_valley` | 深谷 | 0.20 | - |

> 注：前端和后端的默认电价可能略有差异，实际电价以系统"电价配置"模块中的配置为准。

### 9.2 电价差与转移收益

| 转移方向 | 价差 (前端默认) | 每kWh·h日节省 |
|---------|----------------|--------------|
| 尖峰 → 深谷 | 1.40 - 0.20 = **1.20** | 最优 |
| 尖峰 → 谷时 | 1.40 - 0.35 = **1.05** | 次优 |
| 峰时 → 深谷 | 1.00 - 0.20 = **0.80** | 良好 |
| 峰时 → 谷时 | 1.00 - 0.35 = **0.65** | 常规 |
| 峰时 → 平时 | 1.00 - 0.65 = **0.35** | 保守 |
| 平时 → 谷时 | 0.65 - 0.35 = **0.30** | 最保守 |

---

## 10. 收益计算模型

### 10.1 单条规则收益

```
日节省 = power(kW) × hours(h) × (source_price - target_price)(元/kWh)
```

**示例**: 将 30kW 从尖峰转移到深谷，持续 2 小时
```
日节省 = 30 × 2 × (1.40 - 0.20) = 72 元/天
```

### 10.2 年化收益

```
年节省 = Σ(所有规则日节省) × 250(工作日)
```

### 10.3 转移效率因子

后端分析时考虑 **80%** 的转移效率：
```
实际月节省 = 理论月节省 × 0.8
```
考虑因素：设备启停损耗、过渡时段重叠、实际执行偏差等。

---

## 11. 约束与安全机制

### 11.1 设备级约束

| 约束项 | 配置字段 | 说明 |
|--------|---------|------|
| 关键负荷保护 | `is_critical` | 标记为关键负荷的设备完全跳过推荐 |
| 不可转移类型 | TYPE_MAX_RATIOS = 0 | UPS、IT_SERVER、IT_STORAGE 硬编码不可转移 |
| 最低功率限制 | `min_power` | 设备运行的最低功率不可突破 |
| 最大转移时长 | `max_shift_duration` | 单次转移不可超过此时长 |
| 最小连续运行 | `min_continuous_runtime` | 设备启动后至少运行此时长 |
| 爬坡速率限制 | `max_ramp_rate` | 功率变化速度不可超过此值 (kW/min) |
| 禁止时段 | `forbidden_shift_hours` | 这些时段内不允许执行转移 |
| 允许时段 | `allowed_shift_hours` | 仅在这些时段内允许转移 |

### 11.2 算法级安全

| 安全机制 | 值 | 说明 |
|---------|-----|------|
| 安全系数 | ×0.85 | 推荐比例在四约束最小值基础上再打85折 |
| 额定功率校验 | >0 | 额定功率无效时直接返回推荐值0 |
| 范围校正 | 0~type_max | 推荐值强制限制在 [0, 设备类型上限] 范围内 |
| 变更阈值 | >1% | 差异低于1%不触发变更通知 |

### 11.3 执行级安全

| 安全机制 | 说明 |
|---------|------|
| 人工确认 | `requires_manual_approval=True` 时，需人工审批才能执行 |
| 提前通知 | 默认提前30分钟通知，给运维人员准备时间 |
| 手动任务 | 部分任务标记为手动执行，需人工物理操作后确认 |

---

## 12. 执行与追踪

### 12.1 执行计划生命周期

```
 pending(待执行)
    │
    ▼  [点击"开始执行"]
 in_progress(执行中)
    │
    ├──▶ completed(已完成)   [所有任务完成]
    │
    └──▶ cancelled(已取消)   [手动取消]
```

### 12.2 任务类型

| 类型 | 说明 | 操作方式 |
|------|------|---------|
| `auto` | 自动任务 | 系统通过API发送调控指令，点击"执行"触发 |
| `manual` | 手动任务 | 需人工到现场操作设备，完成后点击"标记完成" |

### 12.3 效果追踪指标

| 指标 | 计算方式 |
|------|---------|
| 预期日节省 | 规划阶段计算的理论值 |
| 实际日节省 | 执行前后实际用电数据对比 |
| 达成率 | 实际节省 / 预期节省 × 100% |
| 预期年节省 | 预期日节省 × 250 |
| 实际年节省 | 实际日节省 × 250 |

### 12.4 配置回溯

执行计划的 `device_rules` 字段以 JSON 快照形式保存了创建时的完整规则配置。用户可以在执行管理页面点击"查看原配置"，跳转回分析页面并自动恢复当时的设备选择和规则配置。

---

## 附录

### A. 文件索引

| 文件路径 | 类型 | 说明 |
|---------|------|------|
| `frontend/src/views/energy/config.vue` | 前端页面 | 转移配置选项卡（第295-395行） |
| `frontend/src/views/energy/analysis.vue` | 前端页面 | 负荷转移分析选项卡 |
| `frontend/src/views/energy/execution.vue` | 前端页面 | 执行管理页 |
| `frontend/src/components/energy/ShiftPlanBuilder.vue` | 前端组件 | 方案规划器（核心交互） |
| `frontend/src/components/energy/DeviceShiftDetailDrawer.vue` | 前端组件 | 设备详情抽屉 |
| `frontend/src/components/energy/LoadComparisonChart.vue` | 前端组件 | 负荷对比曲线图 |
| `frontend/src/components/energy/ExecutionPlanDialog.vue` | 前端组件 | 执行确认对话框 |
| `frontend/src/api/modules/energy.ts` | 前端API | 能源转移相关接口 |
| `frontend/src/api/modules/opportunities.ts` | 前端API | 执行计划相关接口 |
| `backend/app/api/v1/energy.py` | 后端路由 | 能源API端点 |
| `backend/app/api/v1/execution.py` | 后端路由 | 执行计划API端点 |
| `backend/app/schemas/energy.py` | 后端Schema | 数据模型定义 |
| `backend/app/models/energy.py` | 后端Model | 数据库表定义 |
| `backend/app/services/device_regulation_service.py` | 后端服务 | 设备调控核心算法 |
| `backend/app/services/energy_analysis.py` | 后端服务 | 负荷转移分析 |
| `backend/app/services/analysis_plugins/load_shifting.py` | 后端插件 | 负荷转移分析插件 |

### B. 数据流总览

```
用户操作                      前端组件                    API端点                        后端服务                      数据库
───────                      ────────                    ──────                        ────────                      ──────
查看推荐     ─────>  config.vue          ─────>  GET shift-ratio/recommendations  ─────>  get_ratio_recommendations()  ─────>  energy_hourly
                                                                                          _calculate_recommendation()          energy_daily
                                                                                                                               device_shift_configs

查看详情     ─────>  DeviceShiftDetail   ─────>  GET typical-day-profile          ─────>  get_device_typical_profile()  ─────>  energy_hourly
             Drawer.vue

调整比例     ─────>  config.vue          ─────>  PUT shift-ratio                  ─────>  update_device_ratio()         ─────>  device_shift_configs

分析转移     ─────>  analysis.vue        ─────>  GET device-shift                 ─────>  analyze_load_shift()          ─────>  energy_daily
                                                                                          _analyze_device_potential()           device_shift_configs

规划方案     ─────>  ShiftPlanBuilder    ─────>  (前端本地计算收益)
             .vue

执行方案     ─────>  ExecutionPlan       ─────>  POST plans/from-shift            ─────>  创建 ExecutionPlan            ─────>  execution_plans
             Dialog.vue                                                                   创建 ExecutionTask                    execution_tasks

追踪效果     ─────>  execution.vue       ─────>  GET plans/{id}/tracking          ─────>  track_execution_effect()      ─────>  energy_daily (对比)
```

---

*文档结束*
