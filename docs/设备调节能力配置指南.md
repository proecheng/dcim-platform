# 设备调节能力配置指南

## 问题说明

节能建议列表的查看详情中，在"参数调整"栏目中的"参与设备"部分是空的。这是因为系统虽然有用电设备数据（`power_devices`表），但缺少设备的转移配置和调节配置数据。

## 解决方案

### 方案1: 新设备自动关联（已实现）✅

**当通过API创建新的用电设备时，系统会自动为其生成转移配置和调节配置**，无需手动操作。

创建设备后自动生成:
- `device_shift_configs` - 设备负荷转移配置
- `load_regulation_configs` - 设备参数调节配置

### 方案2: API批量生成

对于已存在的设备，调用API批量生成配置：

```bash
# 为所有设备生成配置（跳过已有配置）
POST /v1/energy/devices/generate-configs

# 为指定设备生成配置
POST /v1/energy/devices/generate-configs
Content-Type: application/json
{
    "device_ids": [1, 2, 3]
}

# 强制覆盖已有配置
POST /v1/energy/devices/generate-configs?force=true
```

### 方案3: 脚本初始化

运行初始化脚本，一次性为所有设备生成配置：

```bash
cd D:\mytest1\backend
python init_device_regulation.py

# 或运行批处理文件
初始化设备配置.bat
```

## 设备类型智能识别规则

### 可转移负荷设备

| 设备类型 | 可转移比例 | 转移方式 | 允许转移时段 |
|---------|-----------|---------|-------------|
| **空调(AC/HVAC)** | 30-35% | 调节温度/频率 | 非峰时(避开8-9点、18-21点) |
| **照明(LIGHT)** | 50% | 分区控制/调光 | 全天 |
| **水泵(PUMP)** | 40% | 变频调速 | 夜间及非峰时 |
| **冷水机组(CHILLER)** | 25% | 调节出水温度 | 受限时段 |

### 参数可调节设备

| 设备类型 | 调节参数 | 调节范围 | 调节方式说明 |
|---------|---------|---------|-------------|
| **空调(AC/HVAC)** | 温度 | 20-28°C | 每升高1°C，降低约3-4kW功率 |
| **照明(LIGHT)** | 亮度 | 20-100% | 线性调节，亮度与功率成正比 |
| **水泵(PUMP)** | 频率 | 30-50Hz | 功率与频率的立方成正比 |
| **冷水机组(CHILLER)** | 出水温度 | 5-12°C | 每升高1°C，降低约5%功率 |
| **UPS** | 运行模式 | 正常/ECO | ECO模式可降低2%损耗 |

### 关键负荷(不可转移)

- **IT设备**: 服务器、存储、网络设备等关键业务设备
- **UPS**: 保障供电连续性的关键设备

## 自动关联工作流程

```
┌─────────────────────────────────────────────────────────┐
│                    创建新设备                            │
│              POST /v1/energy/devices                    │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│              DeviceConfigAutoGenerator                   │
│  根据 device_type 自动判断设备特性                        │
└─────────────────────────────────────────────────────────┘
                           │
           ┌───────────────┴───────────────┐
           ▼                               ▼
┌──────────────────────┐       ┌──────────────────────┐
│  生成转移配置         │       │  生成调节配置         │
│  device_shift_configs │       │  load_regulation_    │
│                      │       │  configs             │
│  - is_shiftable      │       │  - regulation_type   │
│  - shiftable_ratio   │       │  - min/max_value     │
│  - allowed_hours     │       │  - power_curve       │
└──────────────────────┘       └──────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│              参数调整栏目自动显示设备                      │
│           /v1/energy/devices/shiftable                  │
└─────────────────────────────────────────────────────────┘
```

## 常见问题

### Q1: 新设备创建后会自动关联吗？

**是的**。通过API创建设备时会自动生成配置，无需额外操作。

### Q2: 已存在的设备怎么办？

两种方式：
1. **推荐**: 调用API `POST /v1/energy/devices/generate-configs`
2. 运行脚本 `python init_device_regulation.py`

### Q3: 如何修改某个设备的配置？

配置生成后，可以通过以下方式修改：
1. 调用API更新配置
2. 直接修改数据库记录
3. 使用 `force=true` 参数重新生成

### Q4: 新增设备类型如何支持？

修改 `backend/app/services/device_config_generator.py` 中的模板：
- `SHIFT_TEMPLATES` - 转移配置模板
- `REGULATION_TEMPLATES` - 调节配置模板

## 技术实现

### 核心服务

**DeviceConfigAutoGenerator** (`backend/app/services/device_config_generator.py`)
- 设备配置自动生成器
- 根据设备类型自动选择配置模板
- 支持批量生成和强制覆盖

### API端点

| 端点 | 方法 | 说明 |
|-----|------|-----|
| `/v1/energy/devices` | POST | 创建设备（自动生成配置） |
| `/v1/energy/devices/generate-configs` | POST | 批量生成配置 |
| `/v1/energy/devices/shiftable` | GET | 获取可转移设备列表 |
| `/v1/energy/devices/adjustable` | GET | 获取可调节设备列表 |

### 数据库表

**device_shift_configs** - 设备负荷转移配置
- `device_id`: 关联设备ID
- `is_shiftable`: 是否可转移
- `shiftable_power_ratio`: 可转移功率比例
- `allowed_shift_hours`: 允许转移时段 (JSON)
- `forbidden_shift_hours`: 禁止转移时段 (JSON)

**load_regulation_configs** - 设备参数调节配置
- `device_id`: 关联设备ID
- `regulation_type`: 调节类型 (temperature/brightness/load/mode)
- `min_value/max_value`: 可调范围
- `power_curve`: 功率曲线 (JSON)

---

更新时间: 2026-01-26
