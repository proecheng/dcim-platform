# 节能方案生成流程

> 从数据分析到效果验证的完整闭环流程图解

---

## 流程总览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        节能方案生成与执行流程                              │
└─────────────────────────────────────────────────────────────────────────┘

    ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
    │ 数据采集  │ ──> │ 智能分析  │ ──> │ 方案生成  │ ──> │ 用户决策  │
    └──────────┘     └──────────┘     └──────────┘     └──────────┘
         │                │                │                │
         │                │                │                │
         ▼                ▼                ▼                ▼
    ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
    │ 历史数据  │     │ 特征提取  │     │ 6种模板   │     │ 接受/拒绝 │
    │ 30天+    │     │ ML模型   │     │ 措施列表  │     │ 选择措施  │
    └──────────┘     └──────────┘     └──────────┘     └──────────┘
                                                            │
                                           ┌────────────────┘
                                           ▼
    ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
    │ RL优化   │ <── │ 效果监测  │ <── │ 方案执行  │ <── │ 基准采集  │
    │ (S5)    │     │ (S4)     │     │          │     │ (S4a)   │
    └──────────┘     └──────────┘     └──────────┘     └──────────┘
         │                │
         │                │
         ▼                ▼
    ┌──────────────────────────────┐
    │   自适应优化 (参数微调)        │
    │   闭环反馈到下次方案生成        │
    └──────────────────────────────┘
```

---

## 阶段详解

### 阶段1: 数据采集与预处理

```
数据来源:
├── energy_hourly 表: 小时级功率统计
│   ├── avg_power: 平均功率
│   ├── max_power: 最大功率
│   └── min_power: 最小功率
│
├── energy_daily 表: 日级能耗汇总
│   ├── peak_energy: 峰时用电量
│   ├── valley_energy: 谷时用电量
│   └── total_energy: 总用电量
│
└── power_devices 表: 设备基础信息
    ├── rated_power: 额定功率
    └── device_type: 设备类型

数据要求:
• 至少30天历史数据
• 数据完整度 > 90%
• 无明显异常值
```

### 阶段2: 智能分析 (专利S1+S2)

```
                    ┌─────────────────┐
                    │   输入特征       │
                    └────────┬────────┘
                             │
            ┌────────────────┼────────────────┐
            ▼                ▼                ▼
     ┌──────────┐     ┌──────────┐     ┌──────────┐
     │ GNN模型  │     │Transformer│     │ 规则引擎  │
     │ 设备关系  │     │ 时序预测  │     │ 专家经验  │
     └────┬─────┘     └────┬─────┘     └────┬─────┘
          │                │                │
          └────────────────┼────────────────┘
                           ▼
                    ┌──────────────┐
                    │ 特征融合层    │
                    └──────┬───────┘
                           │
                           ▼
              ┌────────────────────────┐
              │ 输出: 节能潜力评估       │
              │ • 可优化设备列表        │
              │ • 预测节能收益          │
              │ • 置信度评分            │
              └────────────────────────┘
```

### 阶段3: 方案生成

**模板匹配逻辑:**

```python
if 峰谷电价差 > 0.4元 and 可转移负荷 > 100kW:
    生成 B1(峰谷负荷转移方案)

if 空调能耗占比 > 30% and 温度设定 < 26℃:
    生成 A1(空调温度优化方案)

if 照明能耗 > 50kW and 非24小时运行:
    生成 A2(照明智能控制方案)

# ... 更多规则
```

**方案结构:**

```yaml
EnergySavingProposal:
  proposal_code: "A1-20260201-001"
  template_id: "A1"
  template_name: "空调温度优化"
  total_benefit: 12.5  # 万元/年
  measures:
    - measure_code: "M001"
      regulation_object: "空调1#"
      current_state: { temp: 25, power: 50 }
      target_state: { temp: 27, power: 42 }
      expected_saving: 2.8  # 万元/年
    - measure_code: "M002"
      # ...
```

### 阶段4: 用户决策

```
用户操作选项:
┌─────────────────────────────────────────┐
│  □ M001: 空调1#温度调整 (预期节省2.8万)  │
│  ☑ M002: 空调2#温度调整 (预期节省3.2万)  │
│  ☑ M003: 冷水机变频优化 (预期节省6.5万)  │
└─────────────────────────────────────────┘
           │
           ▼
     ┌──────────┐           ┌──────────┐
     │  接受    │    或     │   拒绝   │
     └──────────┘           └──────────┘
           │                      │
           ▼                      ▼
    更新状态为 accepted     记录拒绝原因
    重新计算预期收益        方案归档
```

### 阶段5: 执行与监测 (专利S4)

```
执行前 (S4a 基准采集):
┌──────────────────────────────────────┐
│ 对每个选中措施:                        │
│   1. 记录当前功率 P_before            │
│   2. 记录设备参数 (温度、频率等)        │
│   3. 保存到 MeasureBaseline 表        │
└──────────────────────────────────────┘
                │
                ▼
执行中:
┌──────────────────────────────────────┐
│ 下发控制指令:                          │
│   • 温度设定调整                       │
│   • 设备启停控制                       │
│   • 变频参数修改                       │
│                                      │
│ 记录执行日志:                          │
│   • 指令发送时间                       │
│   • 执行结果 (成功/失败)               │
└──────────────────────────────────────┘
                │
                ▼
执行后 (S4b 持续监测):
┌──────────────────────────────────────┐
│ 每15分钟采集:                          │
│   P_current = 当前功率                │
│   P_saved = P_before - P_current     │
│   E_saved = P_saved × 0.25h          │
│                                      │
│ 存储到 MonitoringRecord 表            │
└──────────────────────────────────────┘
```

### 阶段6: 效果评估与RL优化 (专利S4d+S5)

```
效果达成率计算 (S4d):
┌────────────────────────────────────────────┐
│                                            │
│  达成率 = 实际节能收益 / 预期节能收益 × 100%  │
│                                            │
│  示例:                                      │
│    预期: 12.5万元/年                         │
│    实际: 10.8万元/年 (按比例折算)             │
│    达成率: 86.4%                            │
│                                            │
└────────────────────────────────────────────┘
                    │
                    ▼
RL优化闭环 (S5):
┌────────────────────────────────────────────┐
│                                            │
│  if 达成率 < 80%:                           │
│      触发RL优化                             │
│      输出参数调整建议:                       │
│        • 温度目标值微调                      │
│        • 执行时段优化                        │
│        • 功率分配调整                        │
│                                            │
│  将反馈数据用于下次方案生成                   │
│                                            │
└────────────────────────────────────────────┘
```

---

## 关键API接口

| 阶段 | 接口 | 方法 | 说明 |
|------|------|------|------|
| 分析 | `/proposals/analyze` | POST | 触发智能分析 |
| 查看 | `/proposals/as-suggestions` | GET | 获取方案列表 |
| 详情 | `/proposals/{id}/enhanced` | GET | 获取增强详情 |
| 接受 | `/proposals/{id}/accept` | POST | 接受并选择措施 |
| 执行 | `/proposals/{id}/execute` | POST | 执行方案 |
| 监测 | `/proposals/{id}/effect-summary` | GET | 获取效果汇总 |
| 优化 | `/proposals/{id}/rl/optimize` | POST | 获取RL优化建议 |

---

## 相关文档

- [节能方案操作指南](../2-user-guides/energy-manager/proposal-workflow.md)
- [RL优化流程](./rl-optimization-flow.md)
- [计算公式参考](../4-data-guides/formula-reference.md)
