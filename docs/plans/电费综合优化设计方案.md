# 电费综合优化系统设计方案

## 1. 背景与目标

### 1.1 问题分析

当前系统存在以下局限：
- 仅考虑峰谷电价差套利，忽略了需量电费的影响
- 简单的负荷转移可能在谷时段造成新的功率尖峰，反而增加需量电费
- 缺乏对电费总成本的综合优化

### 1.2 优化目标

**最小化总电费成本**：
```
总电费 = 电量电费 + 基本电费(需量/容量) + 力调电费 + 其他费用
```

**核心约束**：
- 任意15分钟平均功率 ≤ 需量目标值
- 一次超标即锁定当月最大需量电费

## 2. 电费构成模型

### 2.1 电量电费

按分时电价计算：
```
电量电费 = Σ(各时段用电量 × 对应时段电价)
```

**5时段电价配置**（可由用户调整）：
| 时段 | 默认电价(元/kWh) | 典型时间 |
|------|-----------------|---------|
| 尖峰 | 1.20 | 11:00-12:00, 18:00-19:00 |
| 峰 | 0.95 | 9:00-11:00, 12:00-14:00, 17:00-18:00, 19:00-21:00 |
| 平 | 0.65 | 8:00-9:00, 14:00-17:00, 21:00-22:00 |
| 谷 | 0.35 | 4:00-8:00, 22:00-24:00 |
| 深谷 | 0.20 | 0:00-4:00 |

### 2.2 基本电费

两种计费方式（用户选择）：

**按需量计费**：
```
基本电费 = max(实际最大需量, 申报需量×40%) × 需量单价
超过申报需量部分按2倍计价
```

**按容量计费**：
```
基本电费 = 变压器容量 × 容量单价
```

**默认参数**（可配置）：
- 需量单价：40 元/kW·月
- 容量单价：23 元/kVA·月
- 超需量惩罚系数：2.0

### 2.3 力调电费

根据功率因数调整：
```
功率因数 < 0.9：加收电费
功率因数 > 0.9：减免电费
```

## 3. 可调度负荷分类模型

采用通用的6类负荷分类，不依赖具体设备名称：

### 3.1 时移型负荷 (Shiftable)

**特征**：
- 固定能量需求，可灵活选择运行时间
- 完成一次运行需要连续或间歇的固定时长
- 可设置允许/禁止运行时段

**参数**：
- 额定功率 (kW)
- 单次运行时长 (h)
- 每日运行次数
- 允许时段窗口
- 优先级权重

**典型场景**：批处理设备、充电设备、定时任务

### 3.2 削减型负荷 (Curtailable)

**特征**：
- 可在高峰时段临时降低或关闭
- 有最大削减时长限制
- 削减后需要恢复时间

**参数**：
- 额定功率 (kW)
- 可削减比例 (%)
- 最大连续削减时长 (h)
- 每日最大削减次数
- 削减后恢复时间 (h)

**典型场景**：非关键照明、通风、辅助系统

### 3.3 调节型负荷 (Modulating)

**特征**：
- 功率可在一定范围内连续调节
- 调节响应时间快
- 可用于实时功率平衡

**参数**：
- 功率范围 [P_min, P_max] (kW)
- 调节速率 (kW/min)
- 响应延迟 (s)

**典型场景**：变频设备、可调速电机

### 3.4 发电型负荷 (Generation)

**特征**：
- 提供发电能力
- 可能受天气等外部因素影响
- 可能有发电成本

**参数**：
- 额定容量 (kW)
- 发电成本 (元/kWh)
- 可调度性（完全可控/部分可控/不可控）
- 预测曲线（如光伏）

**典型场景**：光伏、备用发电机

### 3.5 储能型负荷 (Storage)

**特征**：
- 可充可放，双向调节
- 有容量和功率限制
- 有充放电效率损失

**参数**：
- 容量 (kWh)
- 最大充电功率 (kW)
- 最大放电功率 (kW)
- 充电效率 (%)
- 放电效率 (%)
- SOC范围 [SOC_min, SOC_max]
- 循环成本 (元/kWh)

**典型场景**：电池储能、蓄冷蓄热

### 3.6 刚性负荷 (Rigid)

**特征**：
- 不可调度，但需要预测
- 作为优化的约束条件

**参数**：
- 历史负荷曲线
- 预测模型参数

**典型场景**：生产核心设备、安全系统

## 4. 分层优化架构

### 4.1 四层架构

```
┌─────────────────────────────────────────────┐
│  第1层：月度策略层                           │
│  - 需量目标设定                              │
│  - 峰谷套利策略                              │
│  - 储能/光伏规划                             │
│  周期：月初制定，周度review                   │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│  第2层：日前调度层                           │
│  - 次日负荷预测                              │
│  - 可调度设备排程                            │
│  - 储能充放电计划                            │
│  周期：每日17:00生成次日计划                  │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│  第3层：实时监控层                           │
│  - 15分钟滚动预测                            │
│  - 需量超标预警                              │
│  - 实时调度指令                              │
│  周期：每分钟更新                            │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│  第4层：反馈学习层                           │
│  - 实际vs计划偏差分析                        │
│  - 预测模型校准                              │
│  - 参数自动优化                              │
│  周期：每周/月分析                           │
└─────────────────────────────────────────────┘
```

### 4.2 各层职责

**月度策略层**：
- 根据历史数据和业务计划设定需量目标
- 计算最优峰谷套利策略
- 评估储能/光伏投资回报

**日前调度层**：
- 预测次日24小时负荷曲线
- 优化可调度设备运行时间
- 制定储能充放电计划
- 生成调度指令表

**实时监控层**：
- 监控当前15分钟平均功率
- 预测未来15分钟是否超标
- 发出预警和紧急调度指令

**反馈学习层**：
- 对比计划与实际执行情况
- 识别预测偏差来源
- 自动调整预测参数

## 5. 约束条件

### 5.1 硬约束（必须满足）

1. **需量约束**：任意15分钟平均功率 ≤ 需量目标值
2. **设备约束**：
   - 功率不超过额定值
   - 储能SOC在允许范围内
   - 时移型负荷在允许时段内运行
3. **能量平衡**：发电+放电+购电 = 负荷+充电+损耗

### 5.2 软约束（尽量满足）

1. **舒适度约束**：温度、照明等在可接受范围内
2. **生产约束**：尽量不影响正常生产计划
3. **设备寿命**：减少频繁启停次数

## 6. 优化算法

### 6.1 算法选择

采用 **MILP (混合整数线性规划)** 作为核心算法：

**优势**：
- 可处理离散变量（设备开关状态）
- 保证全局最优解
- 开源求解器成熟（HiGHS、CBC）

### 6.2 Max函数线性化

需量约束中的max函数通过以下方式线性化：

```
原始：D_max = max(P_net(t)) for all t
线性化：D_max ≥ P_net(t) for all t
```

目标函数中包含 D_max × 需量单价，求解器会自动将 D_max 推到最小可行值。

### 6.3 求解器配置

```python
solver = pulp.HIGHS_CMD(timeLimit=30)  # 最多30秒
# 或
solver = pulp.COIN_CMD(timeLimit=30)
```

## 7. 计算流程

### 7.1 日前调度流程

```
1. 数据准备
   ├── 获取次日预测负荷曲线（96点，15分钟间隔）
   ├── 获取可调度设备列表及参数
   ├── 获取储能/光伏配置
   └── 获取电价配置

2. 建立优化模型
   ├── 定义决策变量
   │   ├── x[d,t]: 设备d在时段t的开关状态 (0/1)
   │   ├── P_charge[t]: 储能充电功率
   │   ├── P_discharge[t]: 储能放电功率
   │   └── D_max: 最大需量
   ├── 定义目标函数
   │   └── min(电量电费 + 需量电费 + 储能损耗成本)
   └── 添加约束条件
       ├── 需量约束
       ├── 设备运行约束
       ├── 储能约束
       └── 能量平衡约束

3. 求解
   └── 调用MILP求解器

4. 结果解析
   ├── 提取设备运行计划
   ├── 提取储能充放电计划
   └── 计算预期成本节省

5. 生成调度指令
   └── 输出可执行的时间表
```

### 7.2 实时监控流程

```
每分钟执行：
1. 获取当前15分钟窗口的累计功率
2. 预测窗口结束时的平均功率
3. 如果预测超过目标值的95%：
   └── 触发黄色预警
4. 如果预测超过目标值：
   └── 触发红色预警，启动紧急削减
```

## 8. 数据库设计

### 8.1 核心表结构

#### 电价配置表 (electricity_pricing_config)
```sql
CREATE TABLE electricity_pricing_config (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,           -- 配置名称
    pricing_type VARCHAR(20) NOT NULL,    -- 'demand' 或 'capacity'
    demand_price DECIMAL(10,2),           -- 需量单价 (元/kW·月)
    capacity_price DECIMAL(10,2),         -- 容量单价 (元/kVA·月)
    declared_demand DECIMAL(10,2),        -- 申报需量 (kW)
    transformer_capacity DECIMAL(10,2),   -- 变压器容量 (kVA)
    over_demand_penalty DECIMAL(3,2) DEFAULT 2.0,  -- 超需量惩罚系数
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 时段定义表 (time_period_config)
```sql
CREATE TABLE time_period_config (
    id SERIAL PRIMARY KEY,
    pricing_config_id INTEGER REFERENCES electricity_pricing_config(id),
    period_type VARCHAR(20) NOT NULL,     -- 'sharp', 'peak', 'flat', 'valley', 'deep_valley'
    price DECIMAL(10,4) NOT NULL,         -- 电价 (元/kWh)
    start_hour INTEGER NOT NULL,          -- 开始小时 (0-23)
    end_hour INTEGER NOT NULL,            -- 结束小时 (0-23)
    months VARCHAR(50),                   -- 适用月份，如 '1,2,3,7,8,9'
    is_workday BOOLEAN DEFAULT true       -- 是否工作日
);
```

#### 可调度设备表 (dispatchable_device)
```sql
CREATE TABLE dispatchable_device (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,           -- 设备名称
    device_type VARCHAR(20) NOT NULL,     -- 'shiftable', 'curtailable', 'modulating', 'generation', 'storage', 'rigid'
    rated_power DECIMAL(10,2) NOT NULL,   -- 额定功率 (kW)
    min_power DECIMAL(10,2),              -- 最小功率 (kW)
    max_power DECIMAL(10,2),              -- 最大功率 (kW)

    -- 时移型参数
    run_duration DECIMAL(5,2),            -- 单次运行时长 (h)
    daily_runs INTEGER,                   -- 每日运行次数
    allowed_periods TEXT,                 -- 允许时段 JSON
    forbidden_periods TEXT,               -- 禁止时段 JSON

    -- 削减型参数
    curtail_ratio DECIMAL(5,2),           -- 可削减比例 (%)
    max_curtail_duration DECIMAL(5,2),    -- 最大削减时长 (h)
    recovery_time DECIMAL(5,2),           -- 恢复时间 (h)

    -- 调节型参数
    ramp_rate DECIMAL(10,2),              -- 调节速率 (kW/min)
    response_delay INTEGER,               -- 响应延迟 (s)

    priority INTEGER DEFAULT 5,           -- 优先级 (1-10)
    is_active BOOLEAN DEFAULT true,
    meter_point_id INTEGER,               -- 关联计量点
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 储能系统配置表 (storage_system_config)
```sql
CREATE TABLE storage_system_config (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    capacity DECIMAL(10,2) NOT NULL,      -- 容量 (kWh)
    max_charge_power DECIMAL(10,2) NOT NULL,    -- 最大充电功率 (kW)
    max_discharge_power DECIMAL(10,2) NOT NULL, -- 最大放电功率 (kW)
    charge_efficiency DECIMAL(5,2) DEFAULT 0.95,  -- 充电效率
    discharge_efficiency DECIMAL(5,2) DEFAULT 0.95, -- 放电效率
    min_soc DECIMAL(5,2) DEFAULT 0.10,    -- 最小SOC
    max_soc DECIMAL(5,2) DEFAULT 0.90,    -- 最大SOC
    cycle_cost DECIMAL(10,4) DEFAULT 0.1, -- 循环成本 (元/kWh)
    is_active BOOLEAN DEFAULT true,
    meter_point_id INTEGER,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 光伏系统配置表 (pv_system_config)
```sql
CREATE TABLE pv_system_config (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    rated_capacity DECIMAL(10,2) NOT NULL, -- 额定容量 (kWp)
    efficiency DECIMAL(5,2) DEFAULT 0.85,  -- 系统效率
    is_controllable BOOLEAN DEFAULT false, -- 是否可调度
    is_active BOOLEAN DEFAULT true,
    meter_point_id INTEGER,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 调度计划表 (dispatch_schedule)
```sql
CREATE TABLE dispatch_schedule (
    id SERIAL PRIMARY KEY,
    schedule_date DATE NOT NULL,
    device_id INTEGER REFERENCES dispatchable_device(id),
    time_slot INTEGER NOT NULL,           -- 时段序号 (0-95, 15分钟间隔)
    action VARCHAR(20) NOT NULL,          -- 'on', 'off', 'charge', 'discharge', 'curtail'
    power_setpoint DECIMAL(10,2),         -- 功率设定值 (kW)
    expected_saving DECIMAL(10,2),        -- 预期节省 (元)
    status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'executed', 'skipped'
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 实时监控记录表 (realtime_monitoring)
```sql
CREATE TABLE realtime_monitoring (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMP NOT NULL,
    current_power DECIMAL(10,2) NOT NULL, -- 当前功率 (kW)
    window_avg_power DECIMAL(10,2),       -- 15分钟窗口平均功率
    demand_target DECIMAL(10,2),          -- 需量目标
    utilization_ratio DECIMAL(5,2),       -- 需量利用率 (%)
    alert_level VARCHAR(20),              -- 'normal', 'warning', 'critical'
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 月度统计表 (monthly_statistics)
```sql
CREATE TABLE monthly_statistics (
    id SERIAL PRIMARY KEY,
    year_month VARCHAR(7) NOT NULL,       -- 'YYYY-MM'
    total_energy DECIMAL(12,2),           -- 总用电量 (kWh)
    max_demand DECIMAL(10,2),             -- 最大需量 (kW)
    demand_target DECIMAL(10,2),          -- 需量目标 (kW)
    energy_cost DECIMAL(12,2),            -- 电量电费 (元)
    demand_cost DECIMAL(12,2),            -- 需量电费 (元)
    total_cost DECIMAL(12,2),             -- 总电费 (元)
    optimized_saving DECIMAL(12,2),       -- 优化节省 (元)
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 优化结果表 (optimization_result)
```sql
CREATE TABLE optimization_result (
    id SERIAL PRIMARY KEY,
    result_date DATE NOT NULL,
    optimization_type VARCHAR(20) NOT NULL, -- 'day_ahead', 'realtime'
    status VARCHAR(20) NOT NULL,          -- 'success', 'failed', 'partial'
    objective_value DECIMAL(12,2),        -- 目标函数值
    solve_time DECIMAL(10,2),             -- 求解时间 (s)
    expected_saving DECIMAL(12,2),        -- 预期节省 (元)
    actual_saving DECIMAL(12,2),          -- 实际节省 (元)
    result_data TEXT,                     -- 详细结果 JSON
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 节能机会表扩展
```sql
-- 在现有 opportunity 表中添加字段
ALTER TABLE opportunity ADD COLUMN optimization_params TEXT;  -- 优化参数 JSON
ALTER TABLE opportunity ADD COLUMN schedule_data TEXT;        -- 调度计划 JSON
```

## 9. API 设计

### 9.1 配置管理 API

```
# 电价配置
GET    /v1/electricity/pricing              # 获取电价配置列表
POST   /v1/electricity/pricing              # 创建电价配置
PUT    /v1/electricity/pricing/{id}         # 更新电价配置
DELETE /v1/electricity/pricing/{id}         # 删除电价配置

# 时段配置
GET    /v1/electricity/periods/{pricing_id}  # 获取时段配置
PUT    /v1/electricity/periods/{pricing_id}  # 批量更新时段配置

# 可调度设备
GET    /v1/dispatch/devices                  # 获取设备列表
POST   /v1/dispatch/devices                  # 添加设备
PUT    /v1/dispatch/devices/{id}             # 更新设备
DELETE /v1/dispatch/devices/{id}             # 删除设备

# 储能配置
GET    /v1/dispatch/storage                  # 获取储能配置
POST   /v1/dispatch/storage                  # 添加储能
PUT    /v1/dispatch/storage/{id}             # 更新储能

# 光伏配置
GET    /v1/dispatch/pv                       # 获取光伏配置
POST   /v1/dispatch/pv                       # 添加光伏
PUT    /v1/dispatch/pv/{id}                  # 更新光伏
```

### 9.2 优化计算 API

```
# 日前调度
POST   /v1/optimization/day-ahead           # 执行日前优化
GET    /v1/optimization/day-ahead/{date}    # 获取日前调度计划
PUT    /v1/optimization/schedule/{id}       # 更新调度状态

# 实时监控
GET    /v1/monitoring/realtime              # 获取实时监控数据
GET    /v1/monitoring/demand-status         # 获取需量状态

# 统计分析
GET    /v1/statistics/monthly/{year_month}  # 获取月度统计
GET    /v1/statistics/saving-analysis       # 获取节省分析
```

## 10. UI 设计

### 10.1 电费分析页（整合原需量分析）

将"需量分析"重命名为"电费分析"，包含以下 Tab：

**Tab 1: 电费总览**
- 当月电费构成饼图
- 电量电费趋势
- 需量电费趋势
- 与上月/去年同期对比

**Tab 2: 需量监控**
- 实时需量仪表盘（需量目标、当前15分钟平均、利用率）
- 24小时需量曲线
- 需量超标预警列表
- 历史需量分布热力图

**Tab 3: 负荷调度**
- 可调度设备列表
- 日前调度计划甘特图
- 储能充放电计划
- 调度执行状态

**Tab 4: 配置管理**
- 电价配置
- 时段定义
- 设备参数配置
- 储能/光伏配置

### 10.2 交互设计

**需量监控仪表盘**：
```
┌────────────────────────────────────────────┐
│  当前需量状态                    [刷新]     │
├────────────────────────────────────────────┤
│                                            │
│    ┌──────────────────────┐               │
│    │     仪表盘             │               │
│    │   [====85%====]       │  需量目标     │
│    │   850/1000 kW         │  1000 kW     │
│    └──────────────────────┘               │
│                                            │
│  本月最大需量: 920 kW    距目标: 80 kW     │
│  当前15分钟平均: 850 kW  状态: 正常 🟢     │
│                                            │
└────────────────────────────────────────────┘
```

**调度甘特图**：
```
┌────────────────────────────────────────────┐
│  2024-01-20 调度计划                        │
├────────────────────────────────────────────┤
│ 设备      0  4  8  12  16  20  24          │
│ ─────────────────────────────────────────  │
│ 设备A     ████████                          │
│ 设备B              ████████                 │
│ 储能充电  ████                  ████        │
│ 储能放电            ████████                │
│ ─────────────────────────────────────────  │
│ 峰 谷 峰  平  峰  平  峰   谷               │
└────────────────────────────────────────────┘
```

## 11. 实施路线

### 第一阶段：基础配置（2周）

**目标**：建立配置管理基础

**任务**：
1. 创建数据库表结构
2. 实现电价配置管理 API
3. 实现可调度设备管理 API
4. 实现储能/光伏配置 API
5. 构建配置管理 UI 页面

**交付物**：
- 可配置电价参数
- 可管理设备列表
- 配置管理页面

### 第二阶段：监控仪表盘（2周）

**目标**：实现实时需量监控

**任务**：
1. 实现实时数据采集接口
2. 构建需量监控仪表盘
3. 实现预警逻辑
4. 构建历史趋势图表

**交付物**：
- 实时需量监控页面
- 预警通知功能
- 历史数据查询

### 第三阶段：优化算法（4周）

**目标**：实现核心优化计算

**任务**：
1. 实现负荷预测模块
2. 实现 MILP 优化模型
3. 实现日前调度计算
4. 实现调度结果展示

**交付物**：
- 日前优化计算功能
- 调度计划甘特图
- 预期节省计算

### 第四阶段：闭环优化（4周）

**目标**：形成完整优化闭环

**任务**：
1. 实现实时调度调整
2. 实现反馈学习模块
3. 实现与节能中心集成
4. 全面测试和优化

**交付物**：
- 完整的优化系统
- 自动节能机会生成
- 性能报告

## 12. 总结

本设计方案提供了一个完整的电费综合优化系统：

1. **全面的成本模型**：考虑电量电费、需量电费、力调电费
2. **通用的负荷分类**：6类可调度负荷，不依赖具体设备类型
3. **分层的优化架构**：月度策略→日前调度→实时监控→反馈学习
4. **可靠的算法基础**：MILP + 线性化技术 + 开源求解器
5. **灵活的配置能力**：电价、设备、储能参数均可用户配置
6. **渐进的实施路线**：4个阶段，12周完成

系统将实现：
- 最小化总电费成本
- 严格遵守需量约束
- 最大化峰谷套利收益
- 自动生成节能机会

---

*文档版本: 1.0*
*创建日期: 2024-01-20*
*最后更新: 2024-01-20*
